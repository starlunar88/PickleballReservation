# 밸런스 모드 1~8경기 로직 정리

## 기본 원칙
- **DUPR 점수만 사용** (내부 랭킹 미사용)
- 플레이어를 DUPR 점수 순으로 정렬: `sorted[0]` = 최강, `sorted[1]` = 차강, `sorted[2]` = 차약, `sorted[3]` = 최약
- 동률인 경우(0.0001 이내) userId로 일관된 정렬 보장
- 각 경기마다 이전 경기와의 중복 방지 (팀 조합, 팀원 조합)
- 같은 라운드 내에서는 플레이어 중복 방지 (1,2,5,6 경기 제외)

---

## 공통 로직 (코트 수 무관)

### 플레이어 정렬 기준
- 전체 플레이어를 DUPR 점수 순으로 정렬 (높은 순)
- 동률인 경우 userId로 일관된 정렬 (같은 순서 유지)
- 각 코트별로 선택된 4명을 다시 DUPR 점수 순으로 정렬하여 `sorted` 배열 생성

### 팀 구성 기본 조합
1. **조합 1 (완벽 밸런스)**: `sorted[0]` + `sorted[3]` vs `sorted[1]` + `sorted[2]`
   - 최강 + 최약 vs 차강 + 차약
2. **조합 2 (밸런스)**: `sorted[0]` + `sorted[2]` vs `sorted[1]` + `sorted[3]`
   - 최강 + 차약 vs 차강 + 최약

---

## 코트 1개 활성화 시 로직

### 1경기
- **플레이어 선택**: 전체 플레이어 중 DUPR 점수 순으로 상위 4명
- **팀 구성**: 
  - Team A: `sorted[0]` (최강) + `sorted[3]` (최약)
  - Team B: `sorted[1]` (차강) + `sorted[2]` (차약)
- **목적**: 완벽한 밸런스 조합 (최강+최약 vs 차강+차약)
- **특징**: 같은 라운드 내 중복 허용 (코트가 1개이므로)

### 2경기
- **플레이어 선택**: 전체 플레이어 중 DUPR 점수 순으로 상위 4명
- **팀 구성**: 
  - Team A: `sorted[0]` (최강) + `sorted[2]` (차약)
  - Team B: `sorted[1]` (차강) + `sorted[3]` (최약)
- **목적**: 1경기와 다른 밸런스 조합 (최강+차약 vs 차강+최약)
- **특징**: 같은 라운드 내 중복 허용 (코트가 1개이므로)

### 3경기
- **플레이어 선택**: 전체 풀에서 참여 횟수가 적은 플레이어 우선 선택
  - 참여 횟수 기준으로 정렬 (적은 순)
  - 같은 횟수면 DUPR 점수 순으로 정렬
  - 전체 풀의 밸런스를 고려하여 선택
- **팀 구성**: 
  - 가능한 밸런스 조합 중 선택 (조합 1 또는 조합 2)
  - 1,2 경기와 다른 조합 사용
- **목적**: 참여 기회 균등 분배
- **중복 방지**: 1,2 경기와 같은 팀 조합 피하기

### 4경기
- **플레이어 선택**: 전체 풀에서 참여 횟수가 적은 플레이어 우선 선택
  - 참여 횟수 기준으로 정렬 (적은 순)
  - 같은 횟수면 DUPR 점수 순으로 정렬
  - 전체 풀의 밸런스를 고려하여 선택
- **팀 구성**: 
  - 가능한 밸런스 조합 중 선택 (조합 1 또는 조합 2)
  - 3경기와 다른 팀원 조합 사용
- **목적**: 참여 기회 균등 분배
- **중복 방지**: 3경기와 같은 팀원 조합 피하기

### 5경기
- **플레이어 선택**: 상위 4명 (DUPR 점수 순) - 고정
- **팀 구성**: 
  - Team A: `sorted[0]` (최강) + `sorted[3]` (최약)
  - Team B: `sorted[1]` (차강) + `sorted[2]` (차약)
- **목적**: 밸런스 조합 (고정 조합)
- **특징**: 같은 라운드 내 중복 허용 (고정된 4명이므로)

### 6경기
- **플레이어 선택**: 상위 4명 (DUPR 점수 순) - 고정
- **팀 구성**: 
  - Team A: `sorted[0]` (최강) + `sorted[2]` (차약)
  - Team B: `sorted[1]` (차강) + `sorted[3]` (최약)
- **목적**: 밸런스 조합 (고정 조합)
- **특징**: 같은 라운드 내 중복 허용 (고정된 4명이므로)

### 7경기
- **플레이어 선택**: 전체 풀에서 참여 안한 플레이어 우선 선택
  - 5,6,1,2 경기에 참여하지 않은 플레이어 우선
  - 참여 횟수와 DUPR 점수를 고려하여 선택
- **팀 구성**: 
  - 가능한 밸런스 조합 중 선택 (조합 1 또는 조합 2)
  - 1,2,3,4,5,6 경기와 다른 조합 사용
- **목적**: 밸런스 조합 유지하며 참여 기회 균등 분배
- **중복 방지**: 1,2,3,4,5,6 경기와 같은 팀 조합 피하기

### 8경기
- **플레이어 선택**: 전체 풀에서 참여 안한 플레이어 우선 선택
  - 5,6,1,2,7 경기에 참여하지 않은 플레이어 우선
  - 참여 횟수와 DUPR 점수를 고려하여 선택
- **팀 구성**: 
  - 가능한 밸런스 조합 중 선택 (조합 1 또는 조합 2)
  - 1,2,3,4,5,6,7 경기와 다른 조합 사용
- **목적**: 밸런스 조합 유지하며 참여 기회 균등 분배
- **중복 방지**: 1,2,3,4,5,6,7 경기와 같은 팀 조합 피하기

---

## 코트 2개 이상 활성화 시 로직

### 1경기
- **플레이어 선택**: 
  - **3코트 이상**: 
    - 코트1: 상위 4명 (1-4번)
    - 코트2: 중위 4명 (5-8번)
    - 코트3: 하위 4명 (9-12번)
    - 코트4 이상: 순환 배정
  - **2코트 이하**: 
    - 홀수 코트: 상위 4명 (1-4번)
    - 짝수 코트: 다음 4명 (5-8번) 또는 하위 4명 (8명 미만일 때)
- **팀 구성**: 각 코트별로 선택된 4명을 정렬한 후
  - Team A: `sorted[0]` (최강) + `sorted[3]` (최약)
  - Team B: `sorted[1]` (차강) + `sorted[2]` (차약)
- **목적**: 코트별로 실력 그룹 분리 (상위/중위/하위 그룹)
- **특징**: 같은 라운드 내 중복 허용 (코트별로 다른 그룹 사용)

### 2경기
- **플레이어 선택**: 
  - **3코트 이상**: 
    - 코트1: 상위 4명 (1-4번)
    - 코트2: 중위 4명 (5-8번)
    - 코트3: 하위 4명 (9-12번)
    - 코트4 이상: 순환 배정
  - **2코트 이하**: 
    - 홀수 코트: 상위 4명 (1-4번)
    - 짝수 코트: 다음 4명 (5-8번) 또는 하위 4명 (8명 미만일 때)
- **팀 구성**: 각 코트별로 선택된 4명을 정렬한 후
  - Team A: `sorted[0]` (최강) + `sorted[2]` (차약)
  - Team B: `sorted[1]` (차강) + `sorted[3]` (최약)
- **목적**: 1경기와 다른 조합 (중복 방지)
- **특징**: 같은 라운드 내 중복 허용 (코트별로 다른 그룹 사용)

### 3경기
- **플레이어 선택**: 전체 풀에서 참여 횟수가 적은 플레이어 우선 선택
  - 참여 횟수 기준으로 정렬 (적은 순)
  - 같은 횟수면 DUPR 점수 순으로 정렬
  - 전체 풀의 밸런스를 고려하여 선택
- **팀 구성**: 
  - 가능한 밸런스 조합 중 선택 (조합 1 또는 조합 2)
  - 1,2 경기와 다른 조합 사용
- **목적**: 참여 기회 균등 분배
- **중복 방지**: 1,2 경기와 같은 팀 조합 피하기

### 4경기
- **플레이어 선택**: 전체 풀에서 참여 횟수가 적은 플레이어 우선 선택
  - 참여 횟수 기준으로 정렬 (적은 순)
  - 같은 횟수면 DUPR 점수 순으로 정렬
  - 전체 풀의 밸런스를 고려하여 선택
- **팀 구성**: 
  - 가능한 밸런스 조합 중 선택 (조합 1 또는 조합 2)
  - 3경기와 다른 팀원 조합 사용
- **목적**: 참여 기회 균등 분배
- **중복 방지**: 3경기와 같은 팀원 조합 피하기

### 5경기
- **플레이어 선택**: 상위 4명 (DUPR 점수 순) - 고정
  - 코트별로 상위 4명 선택 (코트 수에 따라 4명씩 선택)
- **팀 구성**: 각 코트별로 선택된 4명을 정렬한 후
  - Team A: `sorted[0]` (최강) + `sorted[3]` (최약)
  - Team B: `sorted[1]` (차강) + `sorted[2]` (차약)
- **목적**: 밸런스 조합 (고정 조합)
- **특징**: 같은 라운드 내 중복 허용 (고정된 4명이므로)

### 6경기
- **플레이어 선택**: 상위 4명 (DUPR 점수 순) - 고정
  - 코트별로 상위 4명 선택 (코트 수에 따라 4명씩 선택)
- **팀 구성**: 각 코트별로 선택된 4명을 정렬한 후
  - Team A: `sorted[0]` (최강) + `sorted[2]` (차약)
  - Team B: `sorted[1]` (차강) + `sorted[3]` (최약)
- **목적**: 밸런스 조합 (고정 조합)
- **특징**: 같은 라운드 내 중복 허용 (고정된 4명이므로)

### 7경기
- **플레이어 선택**: 전체 풀에서 참여 안한 플레이어 우선 선택
  - 5,6,1,2 경기에 참여하지 않은 플레이어 우선
  - 참여 횟수와 DUPR 점수를 고려하여 선택
- **팀 구성**: 
  - 가능한 밸런스 조합 중 선택 (조합 1 또는 조합 2)
  - 1,2,3,4,5,6 경기와 다른 조합 사용
- **목적**: 밸런스 조합 유지하며 참여 기회 균등 분배
- **중복 방지**: 1,2,3,4,5,6 경기와 같은 팀 조합 피하기

### 8경기
- **플레이어 선택**: 전체 풀에서 참여 안한 플레이어 우선 선택
  - 5,6,1,2,7 경기에 참여하지 않은 플레이어 우선
  - 참여 횟수와 DUPR 점수를 고려하여 선택
- **팀 구성**: 
  - 가능한 밸런스 조합 중 선택 (조합 1 또는 조합 2)
  - 1,2,3,4,5,6,7 경기와 다른 조합 사용
- **목적**: 밸런스 조합 유지하며 참여 기회 균등 분배
- **중복 방지**: 1,2,3,4,5,6,7 경기와 같은 팀 조합 피하기

---

## 주요 차이점 요약

| 경기 | 코트 1개 | 코트 2개 이상 |
|------|---------|--------------|
| **1경기** | 상위 4명, 밸런스 조합 | 코트별 실력 그룹 분리 (상위/중위/하위) |
| **2경기** | 상위 4명, 밸런스 조합 (다른 조합) | 코트별 실력 그룹 분리 (다른 조합) |
| **3경기** | 참여 횟수 고려, 밸런스 조합 | 참여 횟수 고려, 밸런스 조합 |
| **4경기** | 참여 횟수 고려, 밸런스 조합 (3경기와 다른 조합) | 참여 횟수 고려, 밸런스 조합 (3경기와 다른 조합) |
| **5경기** | 상위 4명 고정, 밸런스 조합 | 상위 4명 고정, 밸런스 조합 |
| **6경기** | 상위 4명 고정, 밸런스 조합 (다른 조합) | 상위 4명 고정, 밸런스 조합 (다른 조합) |
| **7경기** | 참여 안한 사람 우선, 밸런스 조합 | 참여 안한 사람 우선, 밸런스 조합 |
| **8경기** | 참여 안한 사람 우선, 밸런스 조합 | 참여 안한 사람 우선, 밸런스 조합 |

---

## 중복 방지 메커니즘

### 1. 팀 조합 중복 방지
- 이전 경기와 동일한 팀 조합 (`teamA|teamB`) 사용 금지
- 양방향 체크: `teamA|teamB`와 `teamB|teamA` 모두 확인

### 2. 팀원 조합 중복 방지 (3,4,7,8 경기)
- 3경기와 4경기: 같은 팀원 조합 사용 금지
- 7경기: 3,4 경기와 같은 팀원 조합 사용 금지
- 8경기: 3,4,7 경기와 같은 팀원 조합 사용 금지

### 3. 같은 라운드 내 플레이어 중복 방지
- 1,2,5,6 경기는 제외 (코트별로 다른 그룹 사용 또는 고정 4명)
- 3,4,7,8 경기는 같은 라운드 내에서 플레이어 중복 방지

### 4. 같은 팀원 반복 방지
- 전체 이력에서 같은 팀원과 반복 매칭 방지 (4,7,8 경기 제외)
- 4,7,8 경기는 이전 특정 경기와의 중복만 체크

---

## 코드 위치 참조

- **경기 번호 결정 로직**: `app.js` 10908-10956 라인
- **플레이어 선택 로직 (1,2 경기)**: `app.js` 11015-11074 라인
- **플레이어 선택 로직 (3,4 경기)**: `app.js` 11075-11300 라인
- **플레이어 선택 로직 (5,6 경기)**: `app.js` 11300-11423 라인
- **플레이어 선택 로직 (7,8 경기)**: `app.js` 11300-11369 라인
- **팀 구성 로직 (1,2 경기)**: `app.js` 11574-11608 라인
- **팀 구성 로직 (3,4 경기)**: `app.js` 11609-11731 라인
- **팀 구성 로직 (5,6 경기)**: `app.js` 11732-11745 라인
- **팀 구성 로직 (7,8 경기)**: `app.js` 11746-11873 라인
- **중복 체크 로직**: `app.js` 11885-12507 라인

